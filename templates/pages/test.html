{% extends "pages/base.html" %}
{% block title %}Test ASR{% endblock %}
{% block content %}
<div class="grid gap-6">
  <section class="rounded-3xl border border-slate-800 bg-slate-900/30 p-6">
    <h2 class="text-2xl font-bold">Test the demo</h2>
    <p class="text-sm text-slate-400 mt-1">Guest uploads are limited by the anonymous plan.</p>

    <div class="mt-4 flex flex-wrap gap-3 items-center">
      <button id="btnDemoToken" class="px-3 py-2 rounded-xl border border-slate-700">Generate demo token</button>
      <span id="demoTokenState" class="text-xs text-slate-400">token: none</span>
    </div>

    <div class="mt-6 grid md:grid-cols-2 gap-4">
      <div class="rounded-2xl border border-slate-800 bg-slate-950/40 p-4">
        <label class="text-sm text-slate-300">Audio file</label>
        <input id="demoFile" type="file" accept="audio/*" class="block w-full text-sm mt-2"/>
        <button id="btnDemoUpload" class="mt-4 px-4 py-2 rounded-xl bg-sky-500 text-slate-900 font-semibold">Upload</button>
        <div id="demoStatus" class="mt-3 text-xs text-slate-400">idle</div>
        <div id="demoError" class="mt-2 text-xs text-rose-400 hidden"></div>
      </div>

      <div class="rounded-2xl border border-slate-800 bg-slate-950/40 p-4">
        <div class="font-semibold text-sm mb-2">Result</div>
        <pre id="demoOutput" class="text-xs bg-black/40 border border-slate-800 rounded-xl p-3 min-h-[220px]">â€”</pre>
      </div>
    </div>
  </section>
</div>

<script>
const csrftoken = document.querySelector('meta[name="csrf-token"]').content;
const demoTokenState = document.getElementById("demoTokenState");
const demoStatus = document.getElementById("demoStatus");
const demoError = document.getElementById("demoError");
const demoOutput = document.getElementById("demoOutput");

function getDemoToken(){ return sessionStorage.getItem("asr_demo_token") || ""; }
function setDemoToken(t){ sessionStorage.setItem("asr_demo_token", t || ""); renderToken(); }
function renderToken(){
  const t = getDemoToken();
  demoTokenState.textContent = t ? ("token: set (" + t.slice(0, 16) + "...)") : "token: none";
}
renderToken();

document.getElementById("btnDemoToken").onclick = async () => {
  const res = await fetch(location.origin + "/api/auth/anon/token/", {
    method: "POST",
    headers: {"X-CSRFToken": csrftoken}
  });
  const data = await res.json();
  if (data.access) {
    setDemoToken(data.access);
  }
};

document.getElementById("btnDemoUpload").onclick = async () => {
  demoError.classList.add("hidden");
  demoError.textContent = "";
  const token = getDemoToken();
  if (!token) {
    demoError.textContent = "Generate a demo token first.";
    demoError.classList.remove("hidden");
    return;
  }
  const file = document.getElementById("demoFile").files[0];
  if (!file) {
    demoError.textContent = "Select an audio file to upload.";
    demoError.classList.remove("hidden");
    return;
  }
  demoStatus.textContent = "uploading...";
  const fd = new FormData();
  fd.append("audio", file);
  fd.append("language", "fa");
  fd.append("auth_token", token);

  const res = await fetch(location.origin + "/api/upload/", {
    method: "POST",
    headers: {"Authorization": "Bearer " + token, "X-CSRFToken": csrftoken},
    body: fd
  });
  const data = await res.json();
  if (!res.ok) {
    demoError.textContent = data.message || "Upload failed.";
    demoError.classList.remove("hidden");
    demoStatus.textContent = "error";
    return;
  }
  const jobId = data.job_id;
  demoStatus.textContent = "queued job=" + jobId;

  const wsProto = location.protocol === "https:" ? "wss" : "ws";
  const ws = new WebSocket(`${wsProto}://${location.host}/ws/jobs/${jobId}/?token=${encodeURIComponent(token)}`);
  ws.onmessage = (ev) => {
    const msg = JSON.parse(ev.data);
    demoStatus.textContent = msg.status || demoStatus.textContent;
    demoOutput.textContent = JSON.stringify(msg, null, 2);
  };
  ws.onerror = () => {
    demoStatus.textContent = "ws error";
  };
};
</script>
{% endblock %}
