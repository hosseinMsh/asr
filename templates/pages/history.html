{% extends "pages/base.html" %}
{% block title %}ASR Gateway | History{% endblock %}
{% block content %}
<div class="layout">
  <aside class="sidebar">
    <h4>Navigation</h4>
    <a href="/dashboard/">Dashboard</a>
    <a href="/account/">Applications</a>
    <a href="/history/" class="active">History</a>
    <a href="/asr/">Recorder</a>
  </aside>

  <section class="stack">
    <div class="panel">
      <h2 style="margin-bottom:6px;">ASR Job History</h2>
      <p class="muted">View completed and in-progress jobs with duration, status, and words processed.</p>
    </div>

    <div class="panel">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h3 style="margin:0;">Jobs</h3>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn-ghost" id="prevPage">Prev</button>
          <span id="pageState" class="muted">Page 1</span>
          <button class="btn-ghost" id="nextPage">Next</button>
        </div>
      </div>
      <div class="card" style="padding:0;">
        <table>
          <thead>
            <tr>
              <th>Job</th>
              <th>Status</th>
              <th>Created</th>
              <th>Duration (s)</th>
              <th>Words</th>
            </tr>
          </thead>
          <tbody id="historyListBody">
            <tr><td class="muted" colspan="5">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    if (!Auth.requireAuth()) return;
    let currentPage = 1;

    async function fetchHistory(page) {
      const res = await fetch(`/api/history/?page=${page}&page_size=10`, { headers: Auth.headers() });
      const data = await res.json().catch(() => ({}));
      return res.ok ? data : {results: []};
    }

    function renderJobs(jobs) {
      const tbody = document.getElementById("historyListBody");
      if (!jobs.length) {
        tbody.innerHTML = '<tr><td class="muted" colspan="5">No jobs found.</td></tr>';
        return;
      }
      tbody.innerHTML = jobs.map(job => `
        <tr>
          <td>${job.id.slice(0,8)}…</td>
          <td><span class="pill ${job.status === 'done' ? 'green' : job.status === 'error' ? 'red' : 'blue'}">${job.status}</span></td>
          <td>${new Date(job.created_at).toLocaleString()}</td>
          <td>${job.audio_duration_sec ?? "—"}</td>
          <td>${job.words_count ?? "—"}</td>
        </tr>
      `).join("");
    }

    async function loadPage(page) {
      const data = await fetchHistory(page);
      renderJobs(data.results || []);
      document.getElementById("pageState").textContent = `Page ${page}`;
    }

    document.getElementById("prevPage").onclick = () => {
      if (currentPage > 1) { currentPage -= 1; loadPage(currentPage); }
    };
    document.getElementById("nextPage").onclick = () => { currentPage += 1; loadPage(currentPage); };

    loadPage(currentPage);
  });
</script>
{% endblock %}
