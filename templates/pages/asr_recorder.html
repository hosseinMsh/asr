{% extends "pages/base.html" %}
{% block title %}ASR Gateway | Recorder{% endblock %}
{% block content %}
<div class="layout">
  <aside class="sidebar">
    <h4>Navigation</h4>
    <a href="/dashboard/">Dashboard</a>
    <a href="/account/">Applications</a>
    <a href="/history/">History</a>
    <a href="/asr/" class="active">Recorder</a>
  </aside>

  <section class="stack">
    <div class="panel">
      <h2 style="margin-bottom:6px;">Recorder & Test ASR</h2>
      <p class="muted">Upload or record audio with your user authentication. API tokens are not needed here.</p>
    </div>

    <div class="two-col">
      <div class="panel">
        <h3>Upload audio</h3>
        <div class="stack" style="margin-top:10px;">
          <input id="file" type="file" accept="audio/*">
          <button class="btn" id="btnUpload">Send to ASR</button>
          <div id="status" class="muted">Idle</div>
          <div id="err" class="muted" style="color:#f87171; display:none;"></div>
        </div>
      </div>

      <div class="panel">
        <h3>Record audio</h3>
        <div class="stack" style="margin-top:10px;">
          <div style="display:flex; gap:8px;">
            <button class="btn-secondary" id="startRec">Start recording</button>
            <button class="btn-ghost" id="stopRec" disabled>Stop</button>
          </div>
          <div class="muted" id="recState">Not recording</div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>Result</h3>
      <pre id="out" style="background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; min-height:200px;">—</pre>
    </div>
  </section>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    if (!Auth.requireAuth()) return;
    const statusEl = document.getElementById("status");
    const errEl = document.getElementById("err");
    const outEl = document.getElementById("out");
    const recState = document.getElementById("recState");
    const startBtn = document.getElementById("startRec");
    const stopBtn = document.getElementById("stopRec");
    let recorder, recordedChunks = [];

    async function uploadAudio(blob, filename="audio.webm") {
      errEl.style.display = "none";
      statusEl.textContent = "Uploading…";
      const fd = new FormData();
      fd.append("audio", blob, filename);
      fd.append("language", "fa");
      const res = await fetch("/api/upload/", {
        method:"POST",
        headers: Auth.headers({"X-CSRFToken": csrftoken}),
        body: fd
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        errEl.textContent = data.message || "Upload failed.";
        errEl.style.display = "block";
        statusEl.textContent = "Error";
        return;
      }
      statusEl.textContent = `Job queued: ${data.job_id}`;
      listenToJob(data.job_id);
    }

    function listenToJob(jobId) {
      const token = Auth.getToken();
      const proto = location.protocol === "https:" ? "wss" : "ws";
      const ws = new WebSocket(`${proto}://${location.host}/ws/jobs/${jobId}/?token=${encodeURIComponent(token)}`);
      ws.onmessage = (ev) => {
        const msg = JSON.parse(ev.data);
        statusEl.textContent = msg.status || statusEl.textContent;
        outEl.textContent = JSON.stringify(msg, null, 2);
      };
      ws.onerror = () => { statusEl.textContent = "WebSocket error"; };
    }

    document.getElementById("btnUpload").onclick = async () => {
      const file = document.getElementById("file").files[0];
      if (!file) {
        errEl.textContent = "Choose an audio file first.";
        errEl.style.display = "block";
        return;
      }
      await uploadAudio(file, file.name);
    };

    startBtn.onclick = async () => {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        recState.textContent = "Recording not supported in this browser.";
        return;
      }
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      recordedChunks = [];
      recorder = new MediaRecorder(stream);
      recorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
      recorder.onstop = () => {
        const blob = new Blob(recordedChunks, {type:"audio/webm"});
        recState.textContent = `Recorded ${(blob.size/1024).toFixed(1)} KB`;
        uploadAudio(blob, "recording.webm");
      };
      recorder.start();
      recState.textContent = "Recording…";
      startBtn.disabled = true;
      stopBtn.disabled = false;
    };

    stopBtn.onclick = () => {
      if (recorder && recorder.state === "recording") {
        recorder.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    };
  });
</script>
{% endblock %}
