{% extends "pages/base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="flex flex-wrap items-center justify-between gap-4">
  <div>
    <p class="uppercase tracking-[0.2em] text-xs text-sky-400/80">Overview</p>
    <h2 class="text-3xl font-bold">Dashboard</h2>
    <p class="text-sm text-slate-400 mt-1">Monitor usage, active jobs, and recent history in one view.</p>
  </div>
  <div class="flex items-center gap-3">
    <a href="/asr/" class="px-4 py-2 rounded-xl bg-sky-400 text-slate-900 font-semibold hover:bg-sky-300">New job</a>
    <a href="/history/" class="px-4 py-2 rounded-xl border border-slate-700 text-slate-200 hover:border-slate-500">History</a>
  </div>
</div>

<div class="mt-6 rounded-3xl border border-slate-800 bg-slate-900/40 p-6 shadow-xl">
  <div class="grid md:grid-cols-4 gap-3 text-sm">
    <div class="rounded-2xl border border-slate-800 bg-slate-950/50 p-4">
      <div class="text-slate-400 text-xs">Total cost</div>
      <div id="cost" class="text-xl font-bold">—</div>
    </div>
    <div class="rounded-2xl border border-slate-800 bg-slate-950/50 p-4">
      <div class="text-slate-400 text-xs">Total audio sec</div>
      <div id="sec" class="text-xl font-bold">—</div>
    </div>
    <div class="rounded-2xl border border-slate-800 bg-slate-950/50 p-4">
      <div class="text-slate-400 text-xs">Total words</div>
      <div id="words" class="text-xl font-bold">—</div>
    </div>
    <div class="rounded-2xl border border-slate-800 bg-slate-950/50 p-4">
      <div class="text-slate-400 text-xs">Jobs</div>
      <div id="count" class="text-xl font-bold">—</div>
    </div>
  </div>
</div>

<div class="mt-8 grid lg:grid-cols-2 gap-6">
  <section class="rounded-3xl border border-slate-800 bg-slate-900/40 p-6 shadow-lg">
    <div class="flex items-center justify-between">
      <div>
        <h3 class="text-lg font-semibold">Active jobs</h3>
        <p class="text-xs text-slate-400">Queued or processing</p>
      </div>
      <span class="text-xs text-slate-500">Live via WebSocket</span>
    </div>
    <div class="mt-4">
      {% include "partials/job_table.html" with table_body_id="activeJobsBody" %}
    </div>
  </section>

  <section class="rounded-3xl border border-slate-800 bg-slate-900/40 p-6 shadow-lg">
    <div class="flex items-center justify-between">
      <div>
        <h3 class="text-lg font-semibold">Recent history</h3>
        <p class="text-xs text-slate-400">Last 6 items within your retention window</p>
      </div>
      <a href="/history/" class="text-xs text-sky-400">View all</a>
    </div>
    <div class="mt-4">
      {% include "partials/job_table.html" with table_body_id="historyBody" %}
    </div>
  </section>
</div>

<script>
const token = localStorage.getItem("asr_access") || "";
async function apiRequest(path, options = {}) {
  const headers = options.headers || {};
  if (token) {
    headers["Authorization"] = "Bearer " + token;
  }
  const opts = {...options, headers};
  return fetch(location.origin + path, opts);
}

async function loadUsage() {
  const res = await apiRequest("/api/usage/", {
    method: "GET"
  });
  const data = await res.json();
  if (!res.ok) {
    document.getElementById("count").textContent = "—";
    return;
  }
  document.getElementById("cost").textContent = data.total_cost_units ?? "—";
  document.getElementById("sec").textContent = data.total_audio_sec ?? "—";
  document.getElementById("words").textContent = data.total_words ?? "—";
  document.getElementById("count").textContent = data.count ?? "—";
}

function renderJobs(targetId, jobs) {
  const tbody = document.getElementById(targetId);
  if (!jobs.length) {
    tbody.innerHTML = '<tr><td class="px-4 py-3 text-slate-400" colspan="5">No jobs found.</td></tr>';
    return;
  }
  tbody.innerHTML = jobs.map(job => `
    <tr>
      <td class="px-4 py-3 text-slate-200 font-mono text-xs">${job.id.slice(0, 8)}...</td>
      <td class="px-4 py-3">${job.status}</td>
      <td class="px-4 py-3">${new Date(job.created_at).toLocaleString()}</td>
      <td class="px-4 py-3">${job.audio_duration_sec ?? "—"}</td>
      <td class="px-4 py-3">${job.words_count ?? "—"}</td>
    </tr>
  `).join("");
}

async function loadHistory() {
  const res = await apiRequest("/api/history/?page=1&page_size=6", {
    method: "GET"
  });
  const data = await res.json();
  if (!res.ok) {
    return;
  }
  const results = data.results || [];
  renderJobs("historyBody", results);
  const active = results.filter(job => ["queued", "processing"].includes(job.status));
  renderJobs("activeJobsBody", active);
}

loadUsage();
loadHistory();
</script>
{% endblock %}
