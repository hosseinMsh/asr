{% extends "pages/base.html" %}
{% block title %}ASR Gateway | Dashboard{% endblock %}
{% block content %}
<div class="layout">
  <aside class="sidebar">
    <h4>Navigation</h4>
    <a href="/dashboard/" class="active">Dashboard</a>
    <a href="/account/">Applications</a>
    <a href="/history/">History</a>
    <a href="/asr/">Recorder</a>
  </aside>

  <section class="stack">
    <div class="panel">
      <h2 style="margin-bottom:6px;">Welcome back</h2>
      <p class="muted">Monitor your usage, jobs, and applications at a glance.</p>
      <div style="display:flex; gap:10px; margin-top:12px;">
        <a class="btn" href="/asr/">Start recording</a>
        <a class="btn-secondary" href="/account/">Manage applications</a>
      </div>
    </div>

    <div class="card-grid">
      <div class="card">
        <div class="muted" style="font-size:13px;">Total cost units</div>
        <div id="cost" style="font-size:28px; font-weight:800;">—</div>
      </div>
      <div class="card">
        <div class="muted" style="font-size:13px;">Audio seconds</div>
        <div id="sec" style="font-size:28px; font-weight:800;">—</div>
      </div>
      <div class="card">
        <div class="muted" style="font-size:13px;">Words processed</div>
        <div id="words" style="font-size:28px; font-weight:800;">—</div>
      </div>
      <div class="card">
        <div class="muted" style="font-size:13px;">Jobs</div>
        <div id="count" style="font-size:28px; font-weight:800;">—</div>
      </div>
      <div class="card">
        <div class="muted" style="font-size:13px;">Applications</div>
        <div id="appsCount" style="font-size:28px; font-weight:800;">—</div>
      </div>
    </div>

    <div class="two-col">
      <div class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3>Active jobs</h3>
          <span class="muted" style="font-size:13px;">Queued or processing</span>
        </div>
        <div class="stack" style="margin-top:12px;" id="activeJobs">
          <div class="muted">Loading…</div>
        </div>
      </div>
      <div class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3>Recent history</h3>
          <a href="/history/" style="color:var(--primary); font-size:13px;">View all</a>
        </div>
        <div class="stack" style="margin-top:12px;" id="historyList">
          <div class="muted">Loading…</div>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    if (!Auth.requireAuth()) return;
    async function fetchJSON(url, opts={}) {
      const res = await fetch(url, { ...opts, headers: Auth.headers(opts.headers || {}) });
      const data = await res.json().catch(() => ({}));
      return {res, data};
    }

    async function loadOverview() {
      const {res, data} = await fetchJSON("/api/dashboard/overview/");
      if (!res.ok) return;
      document.getElementById("cost").textContent = data.total_cost_units ?? "0";
      document.getElementById("sec").textContent = data.total_audio_sec ?? "0";
      document.getElementById("words").textContent = data.total_words ?? "0";
      document.getElementById("count").textContent = data.jobs_count ?? "0";
    }

    async function loadApps() {
      const {res, data} = await fetchJSON("/api/apps/");
      if (res.ok && Array.isArray(data)) {
        document.getElementById("appsCount").textContent = data.length;
      }
    }

    function renderJobCards(targetId, jobs, emptyText) {
      const box = document.getElementById(targetId);
      if (!jobs.length) {
        box.innerHTML = `<div class="muted">${emptyText}</div>`;
        return;
      }
      box.innerHTML = jobs.map(job => `
        <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <div style="font-weight:700;">${job.status}</div>
            <div class="muted" style="font-size:13px;">${new Date(job.created_at).toLocaleString()}</div>
          </div>
          <div class="pill ${job.status === 'done' ? 'green' : job.status === 'error' ? 'red' : 'blue'}">${job.status}</div>
        </div>
      `).join("");
    }

    async function loadHistory() {
      const {res, data} = await fetchJSON("/api/history/?page=1&page_size=8");
      if (!res.ok) return;
      const results = data.results || [];
      renderJobCards("historyList", results, "No jobs yet.");
      const active = results.filter(j => j.status === "queued" || j.status === "processing");
      renderJobCards("activeJobs", active, "No active jobs.");
    }

    loadOverview();
    loadApps();
    loadHistory();
  });
</script>
{% endblock %}
